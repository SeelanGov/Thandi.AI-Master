# CAG Quality Layer - Requirements

## Introduction

The CAG (Critic-Auditor-Governance) Layer is a quality assurance system that sits between RAG output generation and final answer delivery. It ensures all career guidance provided to students is factually accurate, properly sourced, and compliant with South African educational standards and POPIA regulations.

## Glossary

- **CAG Layer**: Critic-Auditor-Governance quality control system
- **RAG Output**: Draft answer generated by LLM based on retrieved knowledge chunks
- **Source Grounding**: Verification that answer claims match retrieved documents
- **Hallucination**: LLM-generated content not supported by retrieved sources
- **Policy Compliance**: Adherence to Thandi.ai safety rules and SA regulations
- **Thandi System**: The complete Thandi.ai career guidance platform

## Requirements

### Requirement 1: Critic Function

**User Story:** As a student, I want to receive factually accurate career information, so that I can make informed decisions about my future.

#### Acceptance Criteria

1. WHEN the CAG Layer receives an LLM draft answer THEN the System SHALL evaluate the answer for factual accuracy against retrieved RAG sources
2. WHEN the draft contains claims not supported by RAG sources THEN the System SHALL flag those claims as potential hallucinations
3. WHEN the draft contains logical inconsistencies THEN the System SHALL identify and mark those inconsistencies
4. WHEN the draft uses incorrect South African terminology THEN the System SHALL detect and flag the terminology errors
5. WHEN factual errors are detected THEN the System SHALL provide specific corrections based on RAG sources

### Requirement 2: Auditor Function

**User Story:** As a compliance officer, I want all career guidance to be traceable to verified sources, so that we can ensure information quality and accountability.

#### Acceptance Criteria

1. WHEN the CAG Layer audits an answer THEN the System SHALL verify that each claim has a corresponding source in the retrieved RAG chunks
2. WHEN a claim lacks source support THEN the System SHALL remove or rewrite the claim using only verified sources
3. WHEN citations are present THEN the System SHALL validate that citations match actual retrieved documents
4. WHEN salary information is provided THEN the System SHALL verify it matches database records and is current for South Africa
5. WHEN qualification requirements are stated THEN the System SHALL confirm they match official university/institution data

### Requirement 3: Governance Function

**User Story:** As a school administrator, I want all guidance to follow safety policies and South African regulations, so that students receive appropriate and compliant advice.

#### Acceptance Criteria

1. WHEN the CAG Layer reviews content THEN the System SHALL enforce Thandi.ai safety policies defined in the rules directory
2. WHEN the answer contains definitive career prescriptions THEN the System SHALL rewrite to provide options and guidance instead
3. WHEN the tone is inappropriate for school-age students THEN the System SHALL adjust the tone to be encouraging and age-appropriate
4. WHEN POPIA-sensitive information appears THEN the System SHALL ensure it has been properly sanitized
5. WHEN dangerous queries are detected THEN the System SHALL apply the dangerous-queries rule and provide appropriate guidance

### Requirement 4: Source Citation Validation

**User Story:** As a student, I want to know where career information comes from, so that I can verify it independently if needed.

#### Acceptance Criteria

1. WHEN the CAG Layer validates an answer THEN the System SHALL ensure all factual claims reference specific RAG chunks
2. WHEN multiple sources support a claim THEN the System SHALL prioritize the most authoritative source
3. WHEN sources conflict THEN the System SHALL flag the conflict and use the most recent or authoritative source
4. WHEN no source exists for a claim THEN the System SHALL remove the claim or mark it as requiring verification
5. WHEN the answer is approved THEN the System SHALL include metadata tracking which sources were used

### Requirement 5: South African Context Enforcement

**User Story:** As a South African student, I want career guidance specific to my country's education system and job market, so that the advice is relevant and actionable.

#### Acceptance Criteria

1. WHEN the CAG Layer reviews content THEN the System SHALL verify all educational pathways reference South African institutions
2. WHEN qualification names are used THEN the System SHALL ensure they match SAQA/NQF terminology
3. WHEN bursary information is provided THEN the System SHALL confirm it applies to South African students
4. WHEN salary ranges are stated THEN the System SHALL verify they are in South African Rands and reflect current market rates
5. WHEN application deadlines are mentioned THEN the System SHALL verify they align with South African academic calendars

### Requirement 6: Hallucination Detection

**User Story:** As a system administrator, I want to detect when the LLM generates unsupported information, so that we can prevent misinformation from reaching students.

#### Acceptance Criteria

1. WHEN the CAG Layer analyzes a draft THEN the System SHALL identify claims that have no corresponding RAG source
2. WHEN specific numbers or dates appear THEN the System SHALL verify they match retrieved documents exactly
3. WHEN institution names are mentioned THEN the System SHALL confirm they exist in the knowledge base
4. WHEN career titles are used THEN the System SHALL verify they match the careers database
5. WHEN hallucinations are detected THEN the System SHALL either remove them or replace with sourced alternatives

### Requirement 7: Policy Rule Integration

**User Story:** As a developer, I want the CAG layer to automatically apply all Thandi.ai rules, so that policy enforcement is consistent and automated.

#### Acceptance Criteria

1. WHEN the CAG Layer processes an answer THEN the System SHALL load and apply all rules from the rules directory
2. WHEN the math-hate-healthcare rule applies THEN the System SHALL verify the answer respects subject prerequisites
3. WHEN the NSFAS-prioritization rule applies THEN the System SHALL ensure budget-appropriate options are prioritized
4. WHEN the scope-boundary rule applies THEN the System SHALL verify the answer stays within career guidance scope
5. WHEN the verification-mandate rule applies THEN the System SHALL include the required verification warning

### Requirement 8: Approval Decision

**User Story:** As a system, I need clear criteria for when to approve, revise, or reject LLM outputs, so that quality control is consistent.

#### Acceptance Criteria

1. WHEN all CAG checks pass THEN the System SHALL approve the answer for delivery
2. WHEN minor issues are detected THEN the System SHALL automatically revise the answer using RAG sources
3. WHEN major hallucinations are detected THEN the System SHALL regenerate the answer with stricter grounding
4. WHEN policy violations are detected THEN the System SHALL reject the answer and return a safe fallback response
5. WHEN the answer cannot be fixed THEN the System SHALL return the RAG draft without LLM enhancement

### Requirement 9: Performance Requirements

**User Story:** As a student, I want quick responses to my career questions, so that I can get guidance without long waits.

#### Acceptance Criteria

1. WHEN the CAG Layer processes an answer THEN the System SHALL complete verification within 2 seconds
2. WHEN using LLM-based verification THEN the System SHALL use efficient models (GPT-4o-mini, Groq Llama)
3. WHEN using rule-based checks THEN the System SHALL execute them in parallel where possible
4. WHEN verification fails repeatedly THEN the System SHALL fall back to RAG draft within 5 seconds total
5. WHEN the system is under load THEN the System SHALL maintain sub-3-second average response times

### Requirement 10: Monitoring and Logging

**User Story:** As a system administrator, I want to track CAG layer performance and decisions, so that I can improve the system over time.

#### Acceptance Criteria

1. WHEN the CAG Layer processes an answer THEN the System SHALL log the decision (approved/revised/rejected)
2. WHEN issues are detected THEN the System SHALL log the specific issue type and location
3. WHEN revisions are made THEN the System SHALL log what was changed and why
4. WHEN sources are validated THEN the System SHALL log which chunks were used
5. WHEN the CAG Layer completes THEN the System SHALL record processing time and model used

---

## Out of Scope

- Real-time fact-checking against external websites
- Manual human review of every answer
- Translation to languages other than English
- Video or audio content verification
- Integration with external career databases beyond Thandi's knowledge base

## Success Criteria

- 95%+ of answers are properly source-grounded
- Zero hallucinated institution names or qualification requirements
- 100% policy compliance (all rules applied)
- Sub-2-second average CAG processing time
- Measurable reduction in student-reported inaccuracies
